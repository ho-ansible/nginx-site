---

- name: nginx site | git clone
  git:
    repo: "{{ site_repo }}"
    dest: "{{ site_dir }}"

- name: nginx site | site config
  copy:
    src: "{{ site_config }}"
    dest: "/etc/nginx/sites-available/{{ site_name }}"
  notify: reload nginx

- name: nginx site | enable site
  file:
    src: "/etc/nginx/sites-available/{{ site_name }}"
    dest: "/etc/nginx/sites-enabled/{{ site_name }}"
    state: link
  notify: reload nginx

- name: nginx site | open port
  tags:
    - iptables
  iptables:
    ip_version: "{{ item }}"
    chain: INPUT
    protocol: tcp
    destination_port: "{{ site_port }}"
    jump: ACCEPT
  with_items: [ ipv4, ipv6 ]
  when: "{{ site.port }}"
  notify: iptables
